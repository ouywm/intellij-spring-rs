<idea-plugin>
    <!-- Plugin ID (unique identifier) -->
    <id>com.spring-rs.plugin</id>

    <!-- Plugin name -->
    <name>Spring Rs</name>

    <!-- Plugin version -->
    <version>0.1.0</version>

    <!-- Vendor -->
    <vendor url="https://github.com/ouywm/intellij-spring-rs">oywm</vendor>

    <!-- Plugin description -->
    <description><![CDATA[
        <p><b>spring-rs</b> — IDE support for the <a href="https://github.com/spring-rs/spring-rs">spring-rs</a> framework, inspired by Java's SpringBoot.</p>

        <h3>TOML Configuration</h3>
        <ul>
          <li><b>Smart Completion</b> — sections, keys, values based on <code>#[derive(Configurable)]</code> structs</li>
          <li><b>Navigation</b> — Ctrl+Click to jump between TOML keys and Rust struct fields</li>
          <li><b>Validation</b> — unknown keys, type mismatches, invalid enums with quick-fixes</li>
          <li><b>Documentation</b> — hover to see field type, default value, and doc comments</li>
          <li><b>Environment Variables</b> — completion, validation, documentation, navigation for <code>${VAR}</code> in TOML</li>
        </ul>

        <h3>Search Everywhere</h3>
        <ul>
          <li>Double-Shift to search routes, jobs, stream listeners, and components</li>
          <li>Results show file path and line number for quick navigation</li>
        </ul>

        <h3>Unified Tool Window</h3>
        <ul>
          <li>Browse Endpoints, Jobs, Stream Listeners, Components, Configurations, Plugins</li>
          <li>Type and module filters, search, tree view with double-click navigation</li>
        </ul>

        <h3>Gutter Line Markers</h3>
        <ul>
          <li><b>Routes</b> — color-coded HTTP method badges (<code>#[get]</code>, <code>#[post]</code>, Router builder)</li>
          <li><b>Jobs</b> — clock icon on <code>#[cron]</code>, <code>#[fix_delay]</code>, <code>#[fix_rate]</code></li>
          <li><b>Stream Listeners</b> — listener icon on <code>#[stream_listener]</code></li>
          <li><b>Cache</b> — cache icon on <code>#[cache]</code></li>
          <li><b>sa-token</b> — security icon on <code>#[sa_check_login]</code>, <code>#[sa_check_role]</code></li>
          <li><b>Socket.IO</b> — web icon on <code>#[on_connection]</code>, <code>#[subscribe_message]</code></li>
          <li><b>Middlewares</b> — middleware icon on <code>#[middlewares]</code></li>
          <li><b>Services</b> — gutter icons for <code>#[derive(Service)]</code> and <code>#[inject]</code></li>
        </ul>

        <h3>Code Generation</h3>
        <ul>
          <li><b>Sea-ORM</b> — generate Entity/DTO/VO/Service/Route from database tables</li>
          <li><b>Live Preview</b> — real-time code preview with prefix stripping and column customization</li>
          <li><b>Templates</b> — customizable Velocity templates with <code>$tool</code> and <code>$callback</code></li>
        </ul>

        <h3>Validation</h3>
        <ul>
          <li><b>Route Conflicts</b> — cross-file duplicate route detection with click-to-navigate</li>
          <li><b>DI Validation</b> — validates <code>#[inject(component)]</code> and <code>#[inject(config)]</code> types</li>
          <li><b>auto_config Completion</b> — <code>WebConfigurator</code>, <code>JobConfigurator</code></li>
        </ul>

        <h3>Other Features</h3>
        <ul>
          <li><b>New Project Wizard</b> — plugin selection, crates.io dependency search, example code</li>
          <li><b>JSON to Rust Struct</b> — convert JSON to Rust structs with serde attributes</li>
          <li><b>Run Configuration</b> — dedicated spring-rs run config with gutter icon</li>
          <li>Custom icons for <code>app.toml</code> config files</li>
          <li>Auto-detection via <code>Cargo.toml</code> dependencies</li>
        </ul>

        <p><b>Requires:</b> RustRover 2025.1+ or IntelliJ IDEA 2023.3+ with Rust plugin</p>
        <p><a href="https://github.com/ouywm/intellij-spring-rs">GitHub</a></p>
    ]]></description>

    <!-- Change notes -->
    <change-notes><![CDATA[
        <b>0.2.0</b>
        <ul>
          <li>Search Everywhere for routes, jobs, stream listeners, components</li>
          <li>Environment variable completion, validation, documentation, navigation in TOML</li>
          <li>Unified tool window with 6 item types and module/type filters</li>
          <li>Gutter line markers for jobs, stream listeners, cache, sa-token, Socket.IO, middlewares</li>
          <li>Sea-ORM code generation with live preview, templates, and multi-dialect support</li>
          <li>Route conflict detection across files with click-to-navigate QuickFix</li>
          <li>DI validation for #[inject(component)] and #[inject(config)]</li>
          <li>Dynamic framework type detection based on Cargo dependencies</li>
          <li>New project wizard with plugin selection and crates.io search</li>
          <li>#[auto_config] completion for WebConfigurator, JobConfigurator</li>
          <li>Unified scanner: 4x performance improvement for large projects</li>
          <li>Settings page with type mapping and template editor</li>
        </ul>
        <b>0.1.0</b> — Initial Release
        <ul>
          <li>TOML config support: completion, navigation, validation, documentation</li>
          <li>Route Explorer tool window with search and color-coded methods</li>
          <li>Dedicated run configuration with custom gutter icon</li>
          <li>JSON to Rust Struct converter</li>
          <li>Service and injection markers</li>
        </ul>
    ]]></change-notes>

    <!-- Required modules -->
    <depends>com.intellij.modules.platform</depends>
    <depends>org.toml.lang</depends>
    <depends>com.jetbrains.rust</depends>
    <!-- Optional: JSON module for syntax highlighting in JSON to Struct dialog -->
    <depends optional="true" config-file="json-features.xml">com.intellij.modules.json</depends>
    <!-- Optional: Database Tools for Sea-ORM code generation from tables -->
    <depends optional="true" config-file="database-features.xml">com.intellij.database</depends>

    <!-- Extensions -->
    <extensions defaultExtensionNs="com.intellij">
        <!-- JSON to Struct history service -->
        <applicationService
            serviceImplementation="com.springrs.plugin.actions.JsonToStructHistoryService"/>

        <!-- File icon provider - spring-rs config files -->
        <fileIconProvider
            implementation="com.springrs.plugin.icons.SpringRsConfigFileIconProvider"/>

        <!-- Typed handler - auto trigger completion when typing '[' -->
        <typedHandler
            implementation="com.springrs.plugin.completion.TomlTypedHandler"/>

        <!-- Tool window - spring-rs routes -->
        <toolWindow
            id="spring-rs Routes"
            anchor="right"
            icon="/icons/spring-rust-logo.svg"
            factoryClass="com.springrs.plugin.toolwindow.SpringRsToolWindowFactory"/>

        <!-- Run Configuration -->
        <configurationType implementation="com.springrs.plugin.run.SpringRsRunConfigurationType"/>
        <runConfigurationProducer implementation="com.springrs.plugin.run.SpringRsRunConfigurationProducer"
                                  order="first"/>

        <!-- Completion -->
        <completion.contributor
            language="TOML"
            implementationClass="com.springrs.plugin.completion.SpringRsConfigCompletionContributor"
            id="SpringRsConfigCompletion"
            order="first"/>

        <!-- Completion - #[auto_config] configurator types -->
        <completion.contributor
            language="Rust"
            implementationClass="com.springrs.plugin.completion.SpringRsAutoConfigCompletionContributor"
            id="SpringRsAutoConfigCompletion"
            order="first"/>

        <!-- Annotator - TOML validation -->
        <annotator
            language="TOML"
            implementationClass="com.springrs.plugin.annotator.SpringRsConfigAnnotator"/>

        <!-- Annotator - Environment variable validation in TOML -->
        <annotator
            language="TOML"
            implementationClass="com.springrs.plugin.annotator.SpringRsEnvVarAnnotator"/>

        <!-- Annotator - Route conflict detection -->
        <annotator
            language="Rust"
            implementationClass="com.springrs.plugin.annotator.SpringRsRouteConflictAnnotator"/>

        <!-- Annotator - Dependency injection validation -->
        <annotator
            language="Rust"
            implementationClass="com.springrs.plugin.annotator.SpringRsDiValidationAnnotator"/>

        <!-- Documentation -->
        <lang.documentationProvider
            language="TOML"
            implementationClass="com.springrs.plugin.documentation.SpringRsConfigDocumentationProvider"/>
        <lang.documentationProvider
            language="TOML"
            implementationClass="com.springrs.plugin.documentation.SpringRsEnvVarDocumentationProvider"
            order="first"/>

        <!-- Line markers -->
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsRouteLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsJobLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsServiceLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsInjectLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsStreamListenerLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsCacheLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsSaTokenLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsSocketIoLineMarkerProvider"/>
        <codeInsight.lineMarkerProvider
            language="Rust"
            implementationClass="com.springrs.plugin.markers.SpringRsMiddlewaresLineMarkerProvider"/>
        <!-- Run gutter icon - override Rust default for spring-rs apps -->
        <runLineMarkerContributor language="Rust"
                                  implementationClass="com.springrs.plugin.run.SpringRsRunLineMarkerContributor"
                                  order="first"/>

        <!-- Search Everywhere - spring-rs items in global search -->
        <searchEverywhereContributor
            implementation="com.springrs.plugin.search.SpringRsSearchEverywhereContributor$Factory"/>

        <!-- References -->
        <psi.referenceContributor
            language="TOML"
            implementation="com.springrs.plugin.references.SpringRsReferenceContributor"/>

        <!-- Directory Project Generator - New Project Wizard (for non-Java IDEs like RustRover) -->
        <directoryProjectGenerator
            implementation="com.springrs.plugin.wizard.SpringRsDirectoryProjectGenerator"/>

        <!-- Internal File Templates for project generation -->
        <internalFileTemplate name="project-Cargo.toml"/>
        <internalFileTemplate name="project-main.rs"/>
        <internalFileTemplate name="project-gitignore"/>
        <internalFileTemplate name="config-app.toml"/>
        <internalFileTemplate name="config-app-dev.toml"/>
        <internalFileTemplate name="config-app-prod.toml"/>
        <internalFileTemplate name="config-app-test.toml"/>
        <internalFileTemplate name="example-web.rs"/>
        <internalFileTemplate name="example-job.rs"/>
        <internalFileTemplate name="example-stream.rs"/>
        <internalFileTemplate name="example-mail.rs"/>
        <internalFileTemplate name="example-redis.rs"/>
        <internalFileTemplate name="example-opendal.rs"/>
        <internalFileTemplate name="example-postgres.rs"/>
        <internalFileTemplate name="example-sqlx.rs"/>
        <internalFileTemplate name="example-sea_orm.rs"/>
        <internalFileTemplate name="example-apalis.rs"/>
        <internalFileTemplate name="example-opentelemetry.rs"/>
        <internalFileTemplate name="example-sa_token.rs"/>
        <internalFileTemplate name="example-grpc.rs"/>
        <internalFileTemplate name="grpc-build.rs"/>
        <internalFileTemplate name="grpc-server.rs"/>
        <internalFileTemplate name="grpc-helloworld.proto"/>

        <!-- Settings: top-level "spring-rs" group (temporarily disabled)
        <applicationConfigurable
            id="SpringRs.Settings"
            displayName="spring-rs"
            instance="com.springrs.plugin.codegen.settings.SpringRsSettingsGroup"/>
        -->

    </extensions>

    <!-- Actions -->
    <actions>
        <!-- JSON to Rust Struct -->
        <action id="SpringRs.JsonToStruct"
                class="com.springrs.plugin.actions.JsonToStructAction"
                text="JSON to Rust Struct"
                description="Convert JSON to Rust struct definitions"
                icon="/icons/spring-rs.svg">
            <add-to-group group-id="EditorPopupMenu" anchor="first"/>
            <add-to-group group-id="GenerateGroup" anchor="first"/>
        </action>
    </actions>
</idea-plugin>
